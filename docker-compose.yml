services:
  ipfs:
    image: ipfs/kubo:latest
    container_name: ipfs-node
    environment:
      - IPFS_PROFILE=server
    ports:
      - "127.0.0.1:4001:4001"  # P2P (Swarm) - localhost only (private mode)
      - "127.0.0.1:5001:5001"  # HTTP RPC API - localhost only
      - "127.0.0.1:8080:8080"  # HTTP Gateway - localhost only
    volumes:
      - ipfs_data:/data/ipfs
      - ipfs_staging:/export
      - ./ipfs-init.d:/container-init.d:ro  # Private mode init script
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "ipfs id || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  ipfs-api:
    build:
      context: ./api
      dockerfile: Dockerfile
    container_name: ipfs-api
    ports:
      - "3000:3000"
    env_file:
      - .env
    environment:
      # Override IPFS_API_URL for internal Docker networking
      - IPFS_API_URL=http://ipfs:5001/api/v0
      # Tell DR scripts which container to docker exec into
      - CONTAINER_NAME=ipfs-node
    volumes:
      - ./snapshots:/app/snapshots  # Mount snapshots directory
      - ./backups:/app/backups      # Mount backups directory
      - /var/run/docker.sock:/var/run/docker.sock  # Docker socket for DR scripts
    depends_on:
      - ipfs
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:3000/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  ipfs_data:
    driver: local
  ipfs_staging:
    driver: local
